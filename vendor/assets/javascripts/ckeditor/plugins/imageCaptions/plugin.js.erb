(function(){

console.log('adding image captions');

	CKEDITOR.plugins.add('imageCaptions',
	{
	    init: function(editor) {

			// register a callback that actually inserts a selected image
			editor._.insertCaptionfn = CKEDITOR.tools.addFunction(function(url, id, name){
				this.insertHtml('<img src="' + url + '" alt="" data-rich-file-id="' + id + '" />');
			}, editor);

			// clean up the callback
			editor.on( 'destroy', function () { CKEDITOR.tools.removeFunction( this._.insertCaptionfn ); } );

			editor.addCommand( 'insertImageCaption', {
				exec: function(editor) {
					var params = {};
					params.CKEditor = editor.name;
					params.CKEditorFuncNum = editor._.insertCaptionfn;
					//params.default_style = editor.config.default_style;
					//params.allowed_styles = editor.config.allowed_styles;
			
					var url = addQueryString(editor.config.richBrowserUrl, params );
					editor.popup(url, 860, 500);
				}
			});


			editor.ui.addButton( 'ImageCaptions', {
				label : "Add Image Caption",
				command: 'insertImageCaption',
				icon: "<%= asset_path 'rich/images.png' %>",
				toolbar: "mediaembed"
			});

	    }
	});

})();
